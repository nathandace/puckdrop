@page "/"
@using PuckDrop.Models.Api
@using PuckDrop.Models.Domain
@using PuckDrop.Services
@inject ITeamService TeamService
@inject NavigationManager Navigation
@rendermode InteractiveServer

<PageTitle>NHL Monitor</PageTitle>

@if (_isLoading)
{
    <div class="loading">
        <div class="spinner"></div>
    </div>
}
else if (_favoriteTeam == null)
{
    <!-- Team Selection -->
    <div class="card" style="max-width: 900px; margin: 0 auto;">
        <div class="card-header">
            <h2 class="card-title">Select Your Favorite Team</h2>
        </div>
        <p class="text-muted mb-3">Choose your favorite NHL team to get started.</p>

        <div class="team-grid">
            @foreach (var team in _allTeams)
            {
                <button class="team-select-btn @(team.Abbrev == _selectedTeamAbbrev ? "selected" : "")"
                        @onclick="() => SelectTeam(team)">
                    <img src="@TeamLogoHelper.GetLogoUrl(team.Abbrev)" alt="@team.Name" class="team-logo" />
                    <span style="font-size: 0.75rem; margin-top: 0.5rem; text-align: center;">@team.Name</span>
                </button>
            }
        </div>

        @if (!string.IsNullOrEmpty(_selectedTeamAbbrev))
        {
            <div class="mt-3" style="text-align: center;">
                <button class="btn btn-primary btn-lg" @onclick="ConfirmTeamSelection" disabled="@_isSaving">
                    @if (_isSaving)
                    {
                        <span>Saving...</span>
                    }
                    else
                    {
                        <span>Confirm Selection</span>
                    }
                </button>
            </div>
        }
    </div>
}

@code {
    private bool _isLoading = true;
    private bool _isSaving;
    private FavoriteTeam? _favoriteTeam;
    private List<NhlTeamInfo> _allTeams = new();
    private string? _selectedTeamAbbrev;
    private NhlTeamInfo? _selectedTeam;

    protected override async Task OnInitializedAsync()
    {
        _isLoading = true;

        try
        {
            _favoriteTeam = await TeamService.GetFavoriteTeamAsync();

            if (_favoriteTeam != null)
            {
                // Redirect to the team page for the favorite team
                Navigation.NavigateTo($"/team/{_favoriteTeam.TeamAbbrev}", replace: true);
                return;
            }

            _allTeams = await TeamService.GetAllTeamsAsync();
        }
        finally
        {
            _isLoading = false;
        }
    }

    private void SelectTeam(NhlTeamInfo team)
    {
        _selectedTeamAbbrev = team.Abbrev;
        _selectedTeam = team;
    }

    private async Task ConfirmTeamSelection()
    {
        if (_selectedTeam == null)
        {
            return;
        }

        _isSaving = true;

        try
        {
            await TeamService.SetFavoriteTeamAsync(
                _selectedTeam.Abbrev,
                _selectedTeam.Name,
                _selectedTeam.LogoUrl,
                _selectedTeam.PrimaryColor,
                _selectedTeam.SecondaryColor);

            // Navigate to the team page
            Navigation.NavigateTo($"/team/{_selectedTeam.Abbrev}", replace: true);
        }
        finally
        {
            _isSaving = false;
        }
    }
}
