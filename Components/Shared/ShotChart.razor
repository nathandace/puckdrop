@using PuckDrop.Models.Api
@using PuckDrop.Helpers
@inject IJSRuntime JS

<div class="shot-chart">
    <div class="section-header">
        <h3>Shot Chart</h3>
        <div class="chart-controls">
            <select class="form-control form-control-sm" @bind="_selectedTeamFilter" style="width: auto; margin-right: 0.5rem;">
                <option value="all">Both Teams</option>
                <option value="away">@AwayTeamAbbrev</option>
                <option value="home">@HomeTeamAbbrev</option>
            </select>
            <select class="form-control form-control-sm" @bind="_selectedPlayerId" style="width: auto; margin-right: 0.5rem;">
                <option value="0">All Players</option>
                @if (RosterSpots != null)
                {
                    var shooters = GetShooters();
                    var awayShooters = shooters.Where(s => s.TeamId == AwayTeamId).OrderBy(s => s.Name);
                    var homeShooters = shooters.Where(s => s.TeamId == HomeTeamId).OrderBy(s => s.Name);

                    @if (awayShooters.Any() && _selectedTeamFilter != "home")
                    {
                        <optgroup label="@AwayTeamAbbrev">
                            @foreach (var shooter in awayShooters)
                            {
                                <option value="@shooter.PlayerId">@shooter.Name (@shooter.ShotCount)</option>
                            }
                        </optgroup>
                    }
                    @if (homeShooters.Any() && _selectedTeamFilter != "away")
                    {
                        <optgroup label="@HomeTeamAbbrev">
                            @foreach (var shooter in homeShooters)
                            {
                                <option value="@shooter.PlayerId">@shooter.Name (@shooter.ShotCount)</option>
                            }
                        </optgroup>
                    }
                }
            </select>
            <select class="form-control form-control-sm" @bind="_dangerZoneFilter" style="width: auto;">
                <option value="all">All Zones</option>
                <option value="high">High Danger</option>
                <option value="medium">Medium Danger</option>
                <option value="low">Low Danger</option>
            </select>
        </div>
    </div>

    <!-- Danger Zone Legend -->
    <div class="chart-legend">
        <span class="legend-item"><span class="marker goal"></span> Goal</span>
        <span class="legend-item"><span class="marker shot"></span> Save</span>
        <span class="legend-item"><span class="marker miss"></span> Miss</span>
        <span class="legend-item"><span class="marker block"></span> Block</span>
        <span class="legend-divider">|</span>
        <span class="legend-item"><span class="danger-marker high"></span> High Danger</span>
        <span class="legend-item"><span class="danger-marker medium"></span> Medium</span>
        <span class="legend-item"><span class="danger-marker low"></span> Low</span>
    </div>

    <div class="chart-container">
        <!-- Hockey Rink SVG -->
        <svg viewBox="0 0 200 85" class="rink-svg" xmlns="http://www.w3.org/2000/svg">
            <!-- Rink outline -->
            <rect x="0" y="0" width="200" height="85" rx="14" ry="14" fill="none" stroke="var(--border-color)" stroke-width="0.5"/>

            <!-- Center line -->
            <line x1="100" y1="0" x2="100" y2="85" stroke="#C41E3A" stroke-width="0.5"/>

            <!-- Blue lines -->
            <line x1="75" y1="0" x2="75" y2="85" stroke="#0066B3" stroke-width="0.5"/>
            <line x1="125" y1="0" x2="125" y2="85" stroke="#0066B3" stroke-width="0.5"/>

            <!-- Goal lines -->
            <line x1="11" y1="0" x2="11" y2="85" stroke="#C41E3A" stroke-width="0.3"/>
            <line x1="189" y1="0" x2="189" y2="85" stroke="#C41E3A" stroke-width="0.3"/>

            <!-- Center circle -->
            <circle cx="100" cy="42.5" r="15" fill="none" stroke="#0066B3" stroke-width="0.3"/>

            <!-- Faceoff circles -->
            <circle cx="31" cy="20.5" r="15" fill="none" stroke="#C41E3A" stroke-width="0.3"/>
            <circle cx="31" cy="64.5" r="15" fill="none" stroke="#C41E3A" stroke-width="0.3"/>
            <circle cx="169" cy="20.5" r="15" fill="none" stroke="#C41E3A" stroke-width="0.3"/>
            <circle cx="169" cy="64.5" r="15" fill="none" stroke="#C41E3A" stroke-width="0.3"/>

            <!-- Creases -->
            <path d="M 5 38 L 5 47 Q 11 42.5 5 38" fill="rgba(0,102,179,0.2)" stroke="#0066B3" stroke-width="0.3"/>
            <path d="M 195 38 L 195 47 Q 189 42.5 195 38" fill="rgba(0,102,179,0.2)" stroke="#0066B3" stroke-width="0.3"/>

            <!-- Goals -->
            <rect x="0" y="39" width="4" height="7" fill="none" stroke="var(--text-muted)" stroke-width="0.3"/>
            <rect x="196" y="39" width="4" height="7" fill="none" stroke="var(--text-muted)" stroke-width="0.3"/>
        </svg>

        <!-- Shot markers overlay -->
        <div class="shots-overlay">
            @if (Plays != null)
            {
                @foreach (var play in GetFilteredShotPlays())
                {
                    var (x, y) = TransformCoordinates(play);
                    var markerClass = GetMarkerClass(play);
                    var teamClass = GetTeamClass(play);
                    var dangerClass = GetDangerClass(play);
                    var xg = ShotAnalytics.CalculateXg(play);

                    <div class="shot-marker @markerClass @teamClass @dangerClass"
                         style="left: @(x.ToString("F2", System.Globalization.CultureInfo.InvariantCulture))%; top: @(y.ToString("F2", System.Globalization.CultureInfo.InvariantCulture))%;"
                         title="@GetTooltip(play, xg)">
                    </div>
                }
            }
        </div>
    </div>

    <!-- Shot Analytics Summary -->
    <div class="chart-stats">
        <div class="team-shots away">
            <span class="team-abbrev">@AwayTeamAbbrev</span>
            <span class="shot-count">@AwayShots SOG</span>
            @if (_awayAnalytics != null)
            {
                <span class="xg-value" title="Expected Goals">xG: @_awayAnalytics.TotalXg.ToString("F2")</span>
            }
        </div>
        <div class="chart-info">
            <span class="text-muted">@PlottedShots shots plotted</span>
        </div>
        <div class="team-shots home">
            <span class="team-abbrev">@HomeTeamAbbrev</span>
            <span class="shot-count">@HomeShots SOG</span>
            @if (_homeAnalytics != null)
            {
                <span class="xg-value" title="Expected Goals">xG: @_homeAnalytics.TotalXg.ToString("F2")</span>
            }
        </div>
    </div>

    <!-- Danger Zone Breakdown -->
    @if (_awayAnalytics != null && _homeAnalytics != null)
    {
        <div class="danger-zone-stats">
            <div class="danger-stat-row">
                <span class="stat-label">High Danger Chances</span>
                <span class="stat-value away">@_awayAnalytics.HighDangerChances</span>
                <span class="stat-divider">-</span>
                <span class="stat-value home">@_homeAnalytics.HighDangerChances</span>
            </div>
            <div class="danger-stat-row">
                <span class="stat-label">Corsi (All Attempts)</span>
                <span class="stat-value away">@_awayAnalytics.Corsi</span>
                <span class="stat-divider">-</span>
                <span class="stat-value home">@_homeAnalytics.Corsi</span>
            </div>
            <div class="danger-stat-row">
                <span class="stat-label">Fenwick (Unblocked)</span>
                <span class="stat-value away">@_awayAnalytics.Fenwick</span>
                <span class="stat-divider">-</span>
                <span class="stat-value home">@_homeAnalytics.Fenwick</span>
            </div>
        </div>
    }
</div>

@code {
    [Parameter]
    public List<Play>? Plays { get; set; }

    [Parameter]
    public string? HomeTeamAbbrev { get; set; }

    [Parameter]
    public string? AwayTeamAbbrev { get; set; }

    [Parameter]
    public int? HomeTeamId { get; set; }

    [Parameter]
    public int? AwayTeamId { get; set; }

    [Parameter]
    public List<RosterSpot>? RosterSpots { get; set; }

    private int _selectedPlayerId;
    private string _selectedTeamFilter = "all";
    private string _dangerZoneFilter = "all";
    private ShotAnalyticsResult? _awayAnalytics;
    private ShotAnalyticsResult? _homeAnalytics;

    private int AwayShots => GetFilteredShotPlays().Count(p => p.Details?.EventOwnerTeamId == AwayTeamId && p.TypeDescKey is "shot-on-goal" or "goal");
    private int HomeShots => GetFilteredShotPlays().Count(p => p.Details?.EventOwnerTeamId == HomeTeamId && p.TypeDescKey is "shot-on-goal" or "goal");
    private int PlottedShots => GetFilteredShotPlays().Count();

    protected override void OnParametersSet()
    {
        // Recalculate analytics when plays change
        if (Plays != null)
        {
            _awayAnalytics = ShotAnalytics.CalculateAggregateAnalytics(Plays, AwayTeamId);
            _homeAnalytics = ShotAnalytics.CalculateAggregateAnalytics(Plays, HomeTeamId);
        }
    }

    private IEnumerable<Play> GetShotPlays()
    {
        if (Plays == null) return Enumerable.Empty<Play>();
        return Plays.Where(p => IsShotPlay(p) && HasCoordinates(p));
    }

    private IEnumerable<Play> GetFilteredShotPlays()
    {
        var shots = GetShotPlays();

        // Filter by team
        if (_selectedTeamFilter == "away")
            shots = shots.Where(p => p.Details?.EventOwnerTeamId == AwayTeamId);
        else if (_selectedTeamFilter == "home")
            shots = shots.Where(p => p.Details?.EventOwnerTeamId == HomeTeamId);

        // Filter by player
        if (_selectedPlayerId != 0)
            shots = shots.Where(p => GetShooterId(p) == _selectedPlayerId);

        // Filter by danger zone
        if (_dangerZoneFilter != "all")
        {
            shots = shots.Where(p =>
            {
                var zone = ShotAnalytics.GetDangerZone(p);
                return _dangerZoneFilter switch
                {
                    "high" => zone == ShotAnalytics.DangerZone.High,
                    "medium" => zone == ShotAnalytics.DangerZone.Medium,
                    "low" => zone == ShotAnalytics.DangerZone.Low,
                    _ => true
                };
            });
        }

        return shots;
    }

    private static int? GetShooterId(Play play)
    {
        return play.TypeDescKey == "goal"
            ? play.Details?.ScoringPlayerId
            : play.Details?.ShootingPlayerId;
    }

    private List<ShooterInfo> GetShooters()
    {
        if (Plays == null || RosterSpots == null) return new List<ShooterInfo>();

        var shooterIds = GetShotPlays()
            .Select(p => GetShooterId(p))
            .Where(id => id.HasValue)
            .GroupBy(id => id!.Value)
            .Select(g => new { PlayerId = g.Key, ShotCount = g.Count() })
            .ToList();

        return shooterIds
            .Select(s =>
            {
                var roster = RosterSpots.FirstOrDefault(r => r.PlayerId == s.PlayerId);
                return new ShooterInfo
                {
                    PlayerId = s.PlayerId,
                    Name = roster != null ? $"{roster.FirstName.Default} {roster.LastName.Default}" : "Unknown",
                    TeamId = roster?.TeamId ?? 0,
                    ShotCount = s.ShotCount
                };
            })
            .OrderByDescending(s => s.ShotCount)
            .ToList();
    }

    private class ShooterInfo
    {
        public int PlayerId { get; set; }
        public string Name { get; set; } = "";
        public int TeamId { get; set; }
        public int ShotCount { get; set; }
    }

    private static bool IsShotPlay(Play play)
    {
        return play.TypeDescKey is "shot-on-goal" or "goal" or "missed-shot" or "blocked-shot";
    }

    private static bool HasCoordinates(Play play)
    {
        return play.Details?.XCoord != null && play.Details?.YCoord != null;
    }

    private (double x, double y) TransformCoordinates(Play play)
    {
        // NHL coordinates: x ranges from -100 to 100 (200 feet), y from -42.5 to 42.5 (85 feet)
        var x = play.Details?.XCoord ?? 0;
        var y = play.Details?.YCoord ?? 0;

        // Normalize to 0-100% (use double literals to avoid integer division!)
        var normalizedX = (x + 100.0) / 200.0 * 100.0;
        var normalizedY = (y + 42.5) / 85.0 * 100.0;

        return (normalizedX, normalizedY);
    }

    private static string GetMarkerClass(Play play)
    {
        return play.TypeDescKey switch
        {
            "goal" => "goal",
            "shot-on-goal" => "shot",
            "missed-shot" => "miss",
            "blocked-shot" => "block",
            _ => "shot"
        };
    }

    private string GetTeamClass(Play play)
    {
        if (play.Details?.EventOwnerTeamId == HomeTeamId) return "home-team";
        if (play.Details?.EventOwnerTeamId == AwayTeamId) return "away-team";
        return "";
    }

    private static string GetDangerClass(Play play)
    {
        var zone = ShotAnalytics.GetDangerZone(play);
        return zone switch
        {
            ShotAnalytics.DangerZone.High => "danger-high",
            ShotAnalytics.DangerZone.Medium => "danger-medium",
            ShotAnalytics.DangerZone.Low => "danger-low",
            _ => ""
        };
    }

    private string GetTooltip(Play play, double? xg = null)
    {
        var type = play.TypeDescKey switch
        {
            "goal" => "GOAL",
            "shot-on-goal" => "Shot on Goal",
            "missed-shot" => "Missed Shot",
            "blocked-shot" => "Blocked Shot",
            _ => "Shot"
        };

        var team = play.Details?.EventOwnerTeamId == HomeTeamId ? HomeTeamAbbrev : AwayTeamAbbrev;
        var zone = ShotAnalytics.GetDangerZone(play);
        var zoneName = ShotAnalytics.GetDangerZoneName(zone);
        var distance = ShotAnalytics.CalculateDistanceToGoal(play);

        var tooltip = $"{type} - {team} ({play.TimeInPeriod} P{play.PeriodDescriptor.Number})";
        tooltip += $"\n{zoneName}";

        if (distance.HasValue)
            tooltip += $" ({distance.Value:F0} ft)";

        if (xg.HasValue)
            tooltip += $"\nxG: {xg.Value:F3}";

        if (!string.IsNullOrEmpty(play.Details?.ShotType))
            tooltip += $"\nShot Type: {play.Details.ShotType}";

        return tooltip;
    }
}
